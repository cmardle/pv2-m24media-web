# Cloudflare Workers Build Configuration for Astro

This document explains the build configuration setup that enables `npm run deploy` to successfully deploy an Astro site to Cloudflare Workers.

## Overview

This project uses Astro with the Cloudflare adapter to build and deploy a static site as a Cloudflare Worker. The build process compiles the Astro site into a Worker-compatible format that can be deployed directly to Cloudflare's edge network.

## Required Dependencies

### Production Dependencies (`dependencies`)

```json
{
  "@astrojs/cloudflare": "12.6.0",
  "@astrojs/sitemap": "3.4.1",
  "astro": "5.10.1",
  "typescript": "5.8.3"
}
```

- **@astrojs/cloudflare**: The official Astro adapter for Cloudflare Pages/Workers
- **@astrojs/sitemap**: Generates sitemap.xml (optional but recommended for SEO)
- **astro**: The core Astro framework
- **typescript**: Required for type checking

### Development Dependencies (`devDependencies`)

```json
{
  "wrangler": "4.21.x"
}
```

- **wrangler**: Cloudflare's CLI tool for deploying and managing Workers

## Configuration Files

### 1. `package.json` Scripts

```json
{
  "scripts": {
    "astro": "astro",
    "build": "astro build",
    "cf-typegen": "wrangler types",
    "check": "astro build && tsc && wrangler deploy --dry-run",
    "deploy": "wrangler deploy",
    "dev": "astro dev",
    "preview": "astro build && wrangler dev"
  },
  "type": "module"
}
```

**Key Points:**
- `"type": "module"` is required for ES modules support
- `build`: Runs Astro's build process, which uses the Cloudflare adapter to generate Worker-compatible output
- `deploy`: Deploys the built site using Wrangler
- `preview`: Builds and runs locally using Wrangler's dev server
- `check`: Validates the build before deployment (optional)

### 2. `astro.config.mjs`

```javascript
// @ts-check
import { defineConfig } from "astro/config";
import sitemap from "@astrojs/sitemap";
import cloudflare from "@astrojs/cloudflare";

// https://astro.build/config
export default defineConfig({
  site: "https://m24media.com",
  integrations: [sitemap()],
  adapter: cloudflare({
    platformProxy: {
      enabled: true,
    },
  }),
});
```

**Key Configuration:**
- **adapter**: Uses `@astrojs/cloudflare` adapter
- **platformProxy.enabled**: Enables Cloudflare platform proxy for local development
- **site**: The production URL (required for sitemap generation)
- **integrations**: Optional integrations like sitemap

### 3. `wrangler.json`

```json
{
  "name": "m24media-web",
  "compatibility_date": "2025-04-01",
  "compatibility_flags": ["nodejs_compat"],
  "main": "./dist/_worker.js/index.js",
  "assets": {
    "directory": "./dist",
    "binding": "ASSETS"
  },
  "observability": {
    "enabled": true
  },
  "upload_source_maps": true
}
```

**Critical Settings:**
- **name**: The Worker name (will be used as the subdomain on workers.dev)
- **compatibility_date**: Sets the Cloudflare Workers runtime version
- **compatibility_flags**: `["nodejs_compat"]` enables Node.js compatibility
- **main**: Points to the Worker entry point generated by Astro (`./dist/_worker.js/index.js`)
- **assets.directory**: Points to the dist folder containing static assets
- **assets.binding**: Names the binding for accessing static assets (must be "ASSETS")
- **upload_source_maps**: Enables source map uploads for better debugging

### 4. `tsconfig.json`

```json
{
  "extends": "astro/tsconfigs/strict",
  "include": [".astro/types.d.ts", "**/*"],
  "exclude": ["dist"],
  "compilerOptions": {
    "strictNullChecks": true
  }
}
```

**Key Points:**
- Extends Astro's strict TypeScript configuration
- Includes Astro's generated type definitions
- Excludes the dist directory from type checking

## Build Output Structure

When you run `astro build`, the Cloudflare adapter generates:

```
dist/
├── _worker.js/
│   └── index.js          # Worker entry point
├── [static assets]       # HTML, CSS, JS, images, etc.
└── ...
```

The `_worker.js/index.js` file is the Cloudflare Worker that serves your site, and it references the static assets in the dist directory through the ASSETS binding.

## Deployment Workflow

### Standard Deployment

```bash
npm run build    # Builds the Astro site with Cloudflare adapter
npm run deploy   # Deploys to Cloudflare Workers using Wrangler
```

### Local Preview

```bash
npm run preview  # Builds and runs locally with Wrangler dev server
```

### Validation Before Deploy

```bash
npm run check    # Builds, type checks, and does a dry-run deployment
```

## How It Works

1. **Build Phase** (`astro build`):
   - Astro compiles your site
   - The `@astrojs/cloudflare` adapter transforms the output into Worker-compatible format
   - Generates `dist/_worker.js/index.js` as the Worker entry point
   - Outputs static assets to the `dist/` directory

2. **Deploy Phase** (`wrangler deploy`):
   - Wrangler reads `wrangler.json` configuration
   - Uploads the Worker code from `dist/_worker.js/index.js`
   - Binds static assets from `dist/` directory to the ASSETS binding
   - Deploys to Cloudflare's edge network

## Additional Files

- **worker-configuration.d.ts**: Type definitions for Cloudflare Worker runtime (auto-generated or manually added)
- **env.d.ts**: Astro environment type definitions

## Important Notes

1. **No wrangler.toml**: This setup uses `wrangler.json` instead of `wrangler.toml`
2. **Automatic Worker Generation**: The Cloudflare adapter automatically generates the Worker code - you don't write it manually
3. **Assets Binding**: The ASSETS binding is crucial for serving static files
4. **Node.js Compatibility**: The `nodejs_compat` flag is needed if your site uses Node.js APIs
5. **Build Before Deploy**: Always run `astro build` before deploying (or use scripts that chain them)

## Replicating This Setup

To replicate this configuration in another repository:

1. Install dependencies: `npm install astro @astrojs/cloudflare @astrojs/sitemap typescript`
2. Install dev dependencies: `npm install -D wrangler`
3. Set `"type": "module"` in package.json
4. Copy the scripts section to package.json
5. Create `astro.config.mjs` with the Cloudflare adapter configuration
6. Create `wrangler.json` with the Worker configuration (update the `name` field)
7. Create `tsconfig.json` with Astro's strict config
8. Run `npm run build` to test the build
9. Run `npm run deploy` to deploy to Cloudflare Workers

## Authentication

Make sure you're authenticated with Cloudflare before deploying:

```bash
npx wrangler login
```

This will open a browser window to authenticate with your Cloudflare account.
